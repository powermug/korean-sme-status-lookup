<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Korean SME Status Lookup</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="shell">
    <section class="hero card">
      <p class="eyebrow">Korean SME Status Lookup</p>
      <h1>중소기업현황정보시스템 실적 조회</h1>
      <p class="sub">
        로그인 세션을 재사용해 회사를 검색하고, 상세 화면의 실적 표를 추출합니다.
      </p>
    </section>

    <section class="card">
      <form method="post" class="query-form" id="query-form">
        <label>
          검색어(사명)
          <input type="text" name="query" value="{{ query }}" placeholder="예: 에이비씨" required>
        </label>
        <label>
          정확 회사명(선택)
          <input type="text" name="company" value="{{ company }}" placeholder="후보 중 특정 회사명 지정">
        </label>
        <button type="submit">조회</button>
      </form>
      <div class="loading-status" id="loading-status" hidden aria-live="polite">
        <span id="loading-message">검색 중</span>
        <span class="loading-dots" aria-hidden="true">
          <span></span><span></span><span></span>
        </span>
      </div>

      {% if not has_session %}
      <div class="notice warn">
        저장된 로그인 세션이 없습니다.
        <code>python -m sminfo_app.cli login</code> 을 먼저 실행하세요.
        <br>
        세션 경로: <code>{{ state_path }}</code>
      </div>
      {% else %}
      <div class="notice ok">
        세션 경로: <code>{{ state_path }}</code>
      </div>
      {% endif %}

      {% if error %}
      <div class="notice error">{{ error }}</div>
      {% endif %}
    </section>

    {% if result %}
    <section class="card result-section">
      <h2>검색 결과</h2>
      <p>
        검색어: <strong>{{ result.query }}</strong>
        / 후보: <strong>{{ result.candidates|length }}</strong>개
        / 추출 표: <strong>{{ result.performance_tables|length }}</strong>개
      </p>

      {% if result.selected %}
      <div class="selected-box">
        선택 회사: <strong>{{ result.selected.name }}</strong>
      </div>
      {% endif %}

      {% if result.candidates %}
      <div class="candidate-grid">
        {% for candidate in result.candidates[:12] %}
        <article class="candidate-item">
          <div>
            <p class="candidate-name">{{ candidate.name }}</p>
            <p class="candidate-meta">
              score {{ candidate.match_score }}
              {% if candidate.table_title %}
              | {{ candidate.table_title }}
              {% endif %}
            </p>
          </div>
          <form method="post">
            <input type="hidden" name="query" value="{{ result.query }}">
            <input type="hidden" name="company" value="{{ candidate.name }}">
            <button type="submit" class="minor">이 회사로 상세조회</button>
          </form>
        </article>
        {% endfor %}
      </div>
      {% endif %}
    </section>

    {% if result.performance_tables %}
    <section class="card result-section">
      <h2>실적 표</h2>
      {% for table in result.performance_tables %}
      <article class="table-card">
        <h3>{{ table.title if table.title else '제목 없음' }}</h3>
        <div class="table-wrap">
          <table>
            {% if table.headers %}
            <thead>
              <tr>
                {% for header in table.headers %}
                <th>{{ header }}</th>
                {% endfor %}
              </tr>
            </thead>
            {% endif %}
            <tbody>
              {% for row in table.rows %}
              <tr>
                {% for cell in row %}
                <td>{{ cell }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </article>
      {% endfor %}
    </section>
    {% endif %}
    {% endif %}
  </main>
  <script>
    (() => {
      const forms = Array.from(document.querySelectorAll("form[method='post']"));
      if (!forms.length) return;

      const loadingStatus = document.getElementById("loading-status");
      const loadingMessage = document.getElementById("loading-message");

      const startLoading = (form) => {
        if (document.body.classList.contains("is-loading")) return;

        const data = new FormData(form);
        const query = (data.get("query") || "").toString().trim();
        const company = (data.get("company") || "").toString().trim();
        const target = company || query || "입력한 회사";

        document.body.classList.add("is-loading");

        if (loadingStatus && loadingMessage) {
          loadingMessage.textContent = `"${target}" 검색 중`;
          loadingStatus.hidden = false;
        }

        document.querySelectorAll("button[type='submit']").forEach((button) => {
          button.disabled = true;
        });

        const mainButton = document.querySelector("#query-form button[type='submit']");
        if (mainButton) {
          mainButton.textContent = "조회 중...";
        }
      };

      forms.forEach((form) => {
        form.addEventListener("submit", (event) => {
          if (document.body.classList.contains("is-loading")) {
            event.preventDefault();
            return;
          }
          startLoading(form);
        });
      });
    })();
  </script>
</body>
</html>
